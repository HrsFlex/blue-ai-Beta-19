<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health AI Companion</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .avatar-container {
            width: 60%;
            height: 100vh;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        .chat-container {
            width: 40%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .emotion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 8px;
        }

        .emotion-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.ai .message-content {
            background: white;
            color: #374151;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .chat-input button {
            padding: 14px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .chat-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .chat-input button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-controls {
            display: flex;
            gap: 8px;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .voice-btn:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            color: white;
            animation: recording-pulse 1.5s infinite;
        }

        .voice-btn.processing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #f59e0b;
            color: white;
        }

        @keyframes recording-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .quick-actions {
            padding: 15px 20px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .quick-actions h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            background: white;
            color: #6b7280;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-1px);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .avatar-container,
            .chat-container {
                width: 100%;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="avatar-container">
        <div id="canvas-container"></div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>Arwen - Your Mental Health Companion</h1>
            <p>I'm here to listen and support you through life's challenges</p>
            <div class="emotion-indicator">
                <div class="emotion-dot"></div>
                <span id="emotion-text">Ready to listen</span>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="message ai">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div>Hi there! I'm Arwen, your mental health companion. I'm here to provide a safe space for you to share your thoughts and feelings. How are you doing today?</div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <div class="quick-actions">
            <h3>How are you feeling?</h3>
            <div class="action-buttons">
                <button class="action-btn" onclick="sendQuickMessage('I\'m feeling anxious today')">üò∞ Anxious</button>
                <button class="action-btn" onclick="sendQuickMessage('I\'m feeling a bit down')">üòî Down</button>
                <button class="action-btn" onclick="sendQuickMessage('I\'m feeling stressed about work')">üò§ Stressed</button>
                <button class="action-btn" onclick="sendQuickMessage('I\'m feeling happy today')">üòä Happy</button>
                <button class="action-btn" onclick="sendQuickMessage('I just need someone to talk to')">üó£Ô∏è Talk</button>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <div class="voice-controls">
                    <button class="voice-btn" id="voice-btn" onclick="toggleVoiceRecording()" title="Voice input">
                        üé§
                    </button>
                </div>
                <input
                    type="text"
                    id="message-input"
                    placeholder="Share how you're feeling..."
                    onkeypress="handleKeyPress(event)"
                >
                <button id="send-btn" onclick="sendMessage()" disabled>
                    Send
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Loading your companion...</p>
        </div>
    </div>

    <script>
        // Global Variables
        let scene, camera, renderer, avatar;
        let isVoiceRecording = false;
        let recognition;
        let isSpeechRecognitionSupported = false;
        let conversationHistory = [];
        let isProcessing = false;
        let emotionState = 'neutral';
        let animationMixer;
        let clock = new THREE.Clock();

        // Emotion colors for avatar
        const emotionColors = {
            happy: '#4ade80',
            sad: '#60a5fa',
            anxious: '#f59e0b',
            angry: '#ef4444',
            neutral: '#8b5cf6',
            stressed: '#f97316'
        };

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeAvatar();
            initializeSpeechRecognition();
            setupEventListeners();
        });

        // Initialize 3D Avatar
        function initializeAvatar() {
            const container = document.getElementById('canvas-container');

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Create simple avatar (will be replaced with actual model)
            createSimpleAvatar();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            // Start animation loop
            animate();

            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.remove('active');
            }, 1000);
        }

        // Create a simple avatar placeholder
        function createSimpleAvatar() {
            const avatarGroup = new THREE.Group();

            // Head
            const headGeometry = new THREE.SphereGeometry(1, 32, 32);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xfdbcb4 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1;
            head.castShadow = true;
            avatarGroup.add(head);

            // Eyes
            const eyeGeometry = new THREE.SphereGeometry(0.1, 16, 16);
            const eyeMaterial = new THREE.MeshPhongMaterial({ color: 0x000000 });

            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.3, 1.1, 0.8);
            avatarGroup.add(leftEye);

            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.3, 1.1, 0.8);
            avatarGroup.add(rightEye);

            // Mouth
            const mouthGeometry = new THREE.SphereGeometry(0.3, 16, 8, 0, Math.PI * 2, 0, Math.PI);
            const mouthMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b6b });
            const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
            mouth.position.set(0, 0.6, 0.8);
            mouth.scale.set(1, 0.3, 0.5);
            avatarGroup.add(mouth);

            // Body
            const bodyGeometry = new THREE.CylinderGeometry(0.8, 1.2, 2, 32);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x667eea });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = -1.5;
            body.castShadow = true;
            avatarGroup.add(body);

            avatar = avatarGroup;
            avatarGroup.name = 'avatar';

            // Store animation mixer
            animationMixer = new THREE.AnimationMixer(avatarGroup);

            scene.add(avatar);
        }

        // Initialize Speech Recognition
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                isSpeechRecognitionSupported = true;

                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    console.log('Voice recognition started');
                    updateVoiceButton('recording');
                };

                recognition.onend = () => {
                    console.log('Voice recognition ended');
                    updateVoiceButton('idle');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Voice input:', transcript);
                    document.getElementById('message-input').value = transcript;
                    sendMessage();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    updateVoiceButton('idle');
                    if (event.error === 'no-speech') {
                        alert('No speech detected. Please try again.');
                    } else {
                        alert('Voice recognition error: ' + event.error);
                    }
                };
            } else {
                console.warn('Speech recognition not supported');
                isSpeechRecognitionSupported = false;
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('input', function() {
                document.getElementById('send-btn').disabled = !this.value.trim();
            });
        }

        // Toggle Voice Recording
        function toggleVoiceRecording() {
            if (!isSpeechRecognitionSupported) {
                alert('Voice recognition is not supported in your browser. Please use Chrome, Firefox, or Edge.');
                return;
            }

            if (isVoiceRecording) {
                recognition.stop();
                isVoiceRecording = false;
            } else {
                recognition.start();
                isVoiceRecording = true;
            }
        }

        // Update Voice Button State
        function updateVoiceButton(state) {
            const btn = document.getElementById('voice-btn');
            btn.className = 'voice-btn';

            switch(state) {
                case 'recording':
                    btn.classList.add('recording');
                    btn.innerHTML = '‚èπÔ∏è';
                    btn.title = 'Stop recording';
                    break;
                case 'processing':
                    btn.classList.add('processing');
                    btn.innerHTML = '‚è≥';
                    btn.title = 'Processing...';
                    break;
                default:
                    btn.innerHTML = 'üé§';
                    btn.title = 'Voice input';
                    isVoiceRecording = false;
            }
        }

        // Handle Enter Key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send Quick Message
        function sendQuickMessage(message) {
            document.getElementById('message-input').value = message;
            sendMessage();
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message || isProcessing) return;

            isProcessing = true;
            input.value = '';
            document.getElementById('send-btn').disabled = true;

            // Add user message to chat
            addMessage(message, 'user');

            // Show typing indicator
            showTypingIndicator();

            try {
                // Detect emotion from message
                emotionState = detectEmotion(message);
                updateEmotionIndicator(emotionState);
                updateAvatarEmotion(emotionState);

                // Get AI response
                const response = await getAIResponse(message);
                addMessage(response, 'ai');

                // Convert response to speech using ElevenLabs
                await speakResponse(response);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('I apologize, but I\'m having trouble responding right now. Please try again.', 'ai');
            } finally {
                hideTypingIndicator();
                isProcessing = false;
                document.getElementById('send-btn').disabled = false;
            }
        }

        // Add Message to Chat
        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div>${content}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Add to conversation history
            conversationHistory.push({
                role: sender === 'user' ? 'user' : 'assistant',
                content: content,
                emotion: sender === 'user' ? emotionState : 'neutral'
            });
        }

        // Get AI Response
        async function getAIResponse(message) {
            try {
                const response = await fetch('http://127.0.0.1:8001/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory,
                        context: 'mental_health_companion'
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                return data.message;

            } catch (error) {
                console.error('AI Response Error:', error);

                // Fallback mental health responses based on detected emotion
                const fallbackResponses = {
                    anxious: "I can hear that you're feeling anxious. Take a deep breath with me. Inhale for 4 counts, hold for 4, and exhale for 6. It's completely normal to feel anxious sometimes. Would you like to talk about what's causing these feelings?",
                    sad: "I'm sorry you're feeling down today. Remember that it's okay to have difficult days. You're not alone in this. What's been on your mind that's making you feel this way?",
                    stressed: "It sounds like you're carrying a heavy burden of stress. Let's take a moment together. What specific aspects are feeling most overwhelming right now?",
                    angry: "I can sense some frustration in your words. Anger is a valid emotion, and it's important to acknowledge it. What's triggering these feelings for you?",
                    happy: "It's wonderful to hear that you're feeling happy! What's been bringing you joy today? I'd love to celebrate this moment with you.",
                    neutral: "Thank you for sharing that with me. I'm here to listen and support you. Could you tell me more about what's on your mind?"
                };

                return fallbackResponses[emotionState] || fallbackResponses.neutral;
            }
        }

        // Speak Response using ElevenLabs
        async function speakResponse(text) {
            try {
                const response = await fetch('http://127.0.0.1:8001/process-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);

                    // Animate avatar while speaking
                    animateAvatarSpeaking();

                    audio.play();
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        stopAvatarSpeaking();
                    };
                }
            } catch (error) {
                console.error('Speech synthesis error:', error);
            }
        }

        // Detect Emotion from Message
        function detectEmotion(message) {
            const anxietyKeywords = ['anxious', 'nervous', 'worried', 'panic', 'fear', 'scared', 'uneasy'];
            const sadnessKeywords = ['sad', 'depressed', 'down', 'blue', 'unhappy', 'cry', 'lonely', 'empty'];
            const stressKeywords = ['stress', 'overwhelmed', 'pressure', 'busy', 'deadline', 'work', 'tired'];
            const angerKeywords = ['angry', 'mad', 'frustrated', 'annoyed', 'upset', 'irritated', 'rage'];
            const happinessKeywords = ['happy', 'joy', 'excited', 'great', 'wonderful', 'amazing', 'good', 'love'];

            const lowerMessage = message.toLowerCase();

            if (anxietyKeywords.some(keyword => lowerMessage.includes(keyword))) return 'anxious';
            if (sadnessKeywords.some(keyword => lowerMessage.includes(keyword))) return 'sad';
            if (stressKeywords.some(keyword => lowerMessage.includes(keyword))) return 'stressed';
            if (angerKeywords.some(keyword => lowerMessage.includes(keyword))) return 'angry';
            if (happinessKeywords.some(keyword => lowerMessage.includes(keyword))) return 'happy';

            return 'neutral';
        }

        // Update Emotion Indicator
        function updateEmotionIndicator(emotion) {
            const emotionText = document.getElementById('emotion-text');
            const emotionDot = document.querySelector('.emotion-dot');

            const emotionMessages = {
                happy: 'Feeling positive',
                sad: 'Listening with empathy',
                anxious: 'Here to calm you',
                angry: 'Understanding your frustration',
                stressed: 'Helping you decompress',
                neutral: 'Ready to listen'
            };

            emotionText.textContent = emotionMessages[emotion] || emotionMessages.neutral;
            emotionDot.style.background = emotionColors[emotion] || emotionColors.neutral;
        }

        // Update Avatar Emotion
        function updateAvatarEmotion(emotion) {
            if (!avatar) return;

            // Change avatar color based on emotion
            const avatarMesh = avatar.children.find(child => child.material && child.material.color);
            if (avatarMesh && emotionColors[emotion]) {
                avatarMesh.material.color.set(emotionColors[emotion]);
            }

            // Add subtle animation based on emotion
            let duration = 1000;
            let intensity = 0.1;

            switch(emotion) {
                case 'anxious':
                    duration = 500;
                    intensity = 0.2;
                    break;
                case 'sad':
                    duration = 2000;
                    intensity = 0.05;
                    break;
                case 'angry':
                    duration = 300;
                    intensity = 0.3;
                    break;
            }

            // Gentle floating animation
            const startY = avatar.position.y;
            const startTime = Date.now();

            function animateEmotion() {
                const elapsed = Date.now() - startTime;
                const progress = (elapsed % duration) / duration;
                const offset = Math.sin(progress * Math.PI * 2) * intensity;

                avatar.position.y = startY + offset;
                avatar.rotation.y = Math.sin(progress * Math.PI * 2) * 0.05;

                if (elapsed < duration * 3) { // Animate for 3 cycles
                    requestAnimationFrame(animateEmotion);
                } else {
                    // Reset position
                    avatar.position.y = startY;
                    avatar.rotation.y = 0;
                }
            }

            animateEmotion();
        }

        // Animate Avatar Speaking
        function animateAvatarSpeaking() {
            if (!avatar) return;

            const mouth = avatar.children.find(child => child.geometry && child.geometry.type === 'SphereGeometry' && child.position.y < 1);
            if (mouth) {
                const originalScale = mouth.scale.y;
                const startTime = Date.now();

                function animateMouth() {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed % 200 / 200;

                    mouth.scale.y = originalScale + Math.sin(progress * Math.PI * 4) * 0.1;

                    // Continue animation if this function is still active
                    if (avatar.userData.isSpeaking) {
                        requestAnimationFrame(animateMouth);
                    } else {
                        mouth.scale.y = originalScale;
                    }
                }

                avatar.userData.isSpeaking = true;
                animateMouth();
            }
        }

        // Stop Avatar Speaking
        function stopAvatarSpeaking() {
            if (avatar) {
                avatar.userData.isSpeaking = false;
            }
        }

        // Show/Hide Typing Indicator
        function showTypingIndicator() {
            document.getElementById('typing-indicator').classList.add('active');
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.remove('active');
        }

        // Window Resize Handler
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();

            if (animationMixer) {
                animationMixer.update(delta);
            }

            // Add gentle floating animation to avatar
            if (avatar && !avatar.userData.isSpeaking) {
                avatar.position.y = Math.sin(Date.now() * 0.001) * 0.05;
                avatar.rotation.y = Math.sin(Date.now() * 0.0005) * 0.02;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>