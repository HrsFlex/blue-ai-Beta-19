<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suzi - Mental Health Companion</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .avatar-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 400px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #avatar-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .chat-section {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .context-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .context-panel h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #4fc3f7;
        }

        .context-item {
            background: rgba(76, 195, 247, 0.1);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            border-left: 3px solid #4fc3f7;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            background: rgba(76, 195, 247, 0.2);
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .message.suzi .message-content {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .audio-player {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #4fc3f7;
            color: #1a237e;
        }

        .progress-container {
            flex: 1;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-display {
            font-size: 0.85rem;
            margin: 0 10px;
            min-width: 100px;
            text-align: center;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .volume-slider {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .message-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 1rem;
            outline: none;
            backdrop-filter: blur(10px);
        }

        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-btn {
            background: #4fc3f7;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            color: #1a237e;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .send-btn:hover {
            background: #29b6f6;
            transform: translateY(-1px);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .voice-controls {
            text-align: center;
            padding: 15px;
        }

        .voice-btn {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s ease;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ff5252, #f44336);
            animation: pulse 1.5s infinite;
        }

        .voice-btn.speaking {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            animation: wave 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(3deg); }
            75% { transform: rotate(-3deg); }
        }

        .upload-section {
            margin-top: 10px;
            text-align: center;
        }

        .upload-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            color: #ffd54f;
        }

        .loading-indicator.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .avatar-section {
                min-height: 300px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ Suzi</h1>
            <p class="subtitle">Your Mental Health Companion with Medical Context</p>
        </div>

        <div class="main-content">
            <div class="avatar-section">
                <div id="avatar-container"></div>
            </div>

            <div class="chat-section">
                <div class="context-panel" id="context-panel" style="display: none;">
                    <h3>üìö Knowledge Sources</h3>
                    <div id="knowledge-sources"></div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                </div>

                <div class="controls-container">
                    <div class="audio-player">
                        <div class="player-controls">
                            <button class="control-btn" id="playPauseBtn" title="Play/Pause">‚ñ∂</button>
                            <button class="control-btn" id="stopBtn" title="Stop">‚èπ</button>
                            <div class="progress-container">
                                <div class="progress-bar" id="progressBar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                            </div>
                            <span class="time-display" id="timeDisplay">0:00</span>
                        </div>
                        <div class="volume-control">
                            <span>üîä</span>
                            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                        </div>
                        <audio id="audioPlayer" style="display: none;"></audio>
                    </div>

                    <div class="input-container">
                        <input type="text" class="message-input" id="messageInput" placeholder="Talk to Suzi about your feelings..." maxlength="1000">
                        <button class="send-btn" id="sendBtn" title="Send Message">Send</button>
                    </div>

                    <div class="voice-controls">
                        <button class="voice-btn" id="voiceBtn" title="Start Recording">üé§</button>
                    </div>

                    <div class="upload-section">
                        <button class="upload-btn" id="uploadReportBtn">üìÑ Upload Medical Report</button>
                        <input type="file" id="medicalReportInput" accept=".pdf" style="display: none;">
                    </div>

                    <div class="loading-indicator" id="loadingIndicator">
                        Suzi is thinking...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Three.js as ES module
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Three.js Avatar System
        let scene, camera, renderer, avatar, mixer;
        let clock = new THREE.Clock();
        let isLoaded = false;

        // Animation variables
        let blinkAnimation = null;
        let talkAnimation = null;
        let currentEmotion = 'neutral';

        // Audio player variables
        let audioPlayer;
        let isPlaying = false;
        let currentTime = 0;
        let duration = 0;

        // Chat variables
        let conversationHistory = [];
        let isRecording = false;

        // Speech Recognition
        let recognition = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initAvatar();
            initAudioPlayer();
            initChatInterface();
            initVoiceRecognition();
            initMedicalUpload();
        });

        function initAvatar() {
            const avatarContainer = document.getElementById('avatar-container');
            const avatarSection = document.querySelector('.avatar-section');

            // Scene setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, avatarSection.offsetWidth / avatarSection.offsetHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(avatarSection.offsetWidth, avatarSection.offsetHeight);
            renderer.setClearColor(0x000000, 0);
            renderer.setPixelRatio(window.devicePixelRatio);
            avatarContainer.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(0, 2, 1);
            scene.add(pointLight);

            // Audio listener for 3D sound
            const listener = new THREE.AudioListener();
            camera.add(listener);

            // Load avatar
            loadAvatar();

            // Animation loop
            animate();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }

        function loadAvatar() {
            const loader = new GLTFLoader();

            // Try to load the model
            loader.load(
                '/static/model.glb',
                function(gltf) {
                    avatar = gltf.scene;

                    // Position avatar
                    avatar.position.set(0, 0, 0);
                    avatar.scale.set(1, 1, 1);

                    // Setup materials for better rendering
                    setupAvatarMaterials();

                    // Add to scene
                    scene.add(avatar);

                    // Setup animations
                    setupAnimations();

                    isLoaded = true;
                    console.log('‚úÖ Avatar loaded successfully');
                },
                function(error) {
                    console.error('‚ùå Error loading avatar:', error);
                    // Create fallback simple avatar
                    createFallbackAvatar();
                }
            );
        }

        function setupAvatarMaterials() {
            avatar.traverse((child) => {
                if (child.isMesh) {
                    // Enable shadows
                    child.castShadow = true;
                    child.receiveShadow = true;

                    // Enhance material properties
                    const material = child.material;
                    if (material) {
                        material.roughness = 0.7;
                        material.metalness = 0.2;
                        material.envMapIntensity = 0.3;

                        // Better color handling for realistic look
                        if (material.map) {
                            material.map.colorSpace = THREE.SRGBColorSpace;
                        }
                        if (material.normalMap) {
                            material.normalMap.colorSpace = THREE.NoColorSpace;
                        }
                        if (material.roughnessMap) {
                            material.roughnessMap.colorSpace = THREE.NoColorSpace;
                        }
                        if (material.metalnessMap) {
                            material.metalnessMap.colorSpace = THREE.NoColorSpace;
                        }
                        if (material.emissiveMap) {
                            material.emissiveMap.colorSpace = THREE.SRGBColorSpace;
                        }
                        if (material.occlusionMap) {
                            material.occlusionMap.colorSpace = THREE.NoColorSpace;
                        }
                    }
                }
            });
        }

        function createFallbackAvatar() {
            const geometry = new THREE.SphereGeometry(0.5, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: 0xffb6c1,
                emissive: 0x4444ff,
                shininess: 100
            });
            avatar = new THREE.Mesh(geometry, material);
            avatar.position.set(0, 0, 0);
            scene.add(avatar);
        }

        function setupAnimations() {
            // Load animation data if available
            fetch('/static/blendDataBlink.json')
                .then(response => response.json())
                .then(blinkData => {
                    blinkAnimation = blinkData;
                    console.log('‚úÖ Animation data loaded');
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è No animation data found:', error);
                });

            // Create simple idle animation if no complex data
            createIdleAnimation();
        }

        function createIdleAnimation() {
            // Create mixer for the avatar
            mixer = new THREE.AnimationMixer(avatar);

            // Simple breathing animation using subtle position changes
            const times = [0, 1, 2, 3, 4];
            const values = [0, 0.02, 0, -0.02, 0]; // Subtle breathing motion

            const track = new THREE.NumberKeyframeTrack(
                avatar.position + '.y', // Y position track
                times,
                values
            );

            const clip = new THREE.AnimationClip('idle', 4, [track]);
            const action = mixer.clipAction(clip);
            action.setLoop(THREE.LoopRepeat, Infinity); // Use THREE.LoopRepeat
            mixer.timeScale = 1; // Normal speed
            action.play();
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!isLoaded) return;

            const delta = clock.getDelta();

            // Update animations
            if (mixer) {
                mixer.update(delta);
            }

            // Subtle rotation for liveliness
            if (avatar) {
                avatar.rotation.y += delta * 0.5;
            }

            // Camera follows avatar smoothly
            if (avatar && camera) {
                camera.lookAt(avatar.position);
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const avatarSection = document.querySelector('.avatar-section');
            camera.aspect = avatarSection.offsetWidth / avatarSection.offsetHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(avatarSection.offsetWidth, avatarSection.offsetHeight);
        }

        // Enhanced Audio Player Functions
        function initAudioPlayer() {
            audioPlayer = document.getElementById('audioPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const timeDisplay = document.getElementById('timeDisplay');
            const volumeSlider = document.getElementById('volumeSlider');

            // Play/Pause button
            playPauseBtn.addEventListener('click', togglePlayPause);

            // Stop button
            stopBtn.addEventListener('click', stopAudio);

            // Progress bar
            progressBar.addEventListener('click', seekAudio);

            // Volume control
            volumeSlider.addEventListener('input', updateVolume);

            // Audio events
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('ended', onAudioEnded);
        }

        function togglePlayPause() {
            if (!audioPlayer.src || audioPlayer.src === '') {
                return;
            }

            const playPauseBtn = document.getElementById('playPauseBtn');

            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.textContent = '‚è∏';
                playPauseBtn.classList.add('active');
                isPlaying = true;
            } else {
                audioPlayer.pause();
                playPauseBtn.textContent = '‚ñ∂';
                playPauseBtn.classList.remove('active');
                isPlaying = false;
            }
        }

        function stopAudio() {
            if (audioPlayer.src) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                updateProgress();
                const playPauseBtn = document.getElementById('playPauseBtn');
                playPauseBtn.textContent = '‚ñ∂';
                playPauseBtn.classList.remove('active');
                isPlaying = false;
            }
        }

        function seekAudio(e) {
            if (audioPlayer.src && audioPlayer.duration) {
                const rect = e.currentTarget.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            }
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const timeDisplay = document.getElementById('timeDisplay');

            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percent + '%';

                const currentMinutes = Math.floor(audioPlayer.currentTime / 60);
                const currentSeconds = Math.floor(audioPlayer.currentTime % 60);
                const durationMinutes = Math.floor(audioPlayer.duration / 60);
                const durationSeconds = Math.floor(audioPlayer.duration % 60);

                timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}/${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
            } else {
                progressFill.style.width = '0%';
                timeDisplay.textContent = '0:00';
            }
        }

        function updateDuration() {
            duration = audioPlayer.duration;
            updateProgress();
        }

        function onAudioEnded() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            playPauseBtn.textContent = '‚ñ∂';
            playPauseBtn.classList.remove('active');
            isPlaying = false;
            updateProgress();

            // Reset avatar emotion to neutral
            setEmotion('neutral');
        }

        function updateVolume() {
            const volumeSlider = document.getElementById('volumeSlider');
            audioPlayer.volume = volumeSlider.value / 100;
        }

        // Expression control
        function setEmotion(emotion) {
            currentEmotion = emotion;

            // Trigger facial expression changes
            updateAvatarEmotion(emotion);

            // Add visual feedback
            if (avatar) {
                // Change color based on emotion
                const emotionColors = {
                    'happy': '#ffeb3b',
                    'sad': '#64b5f6',
                    'neutral': '#81c784',
                    'excited': '#ff8a65'
                };

                avatar.traverse((child) => {
                    if (child.isMesh && child.material) {
                        child.material.emissive = new THREE.Color(emotionColors[emotion] || '#81c784');
                    }
                });
            }
        }

        function updateAvatarEmotion(emotion) {
            // Implementation for complex facial expressions
            if (blinkAnimation && emotion === 'happy') {
                // Trigger happy expression animation
                animateExpression(emotion);
            }
        }

        function animateExpression(emotion) {
            // Implement expression animation
            if (avatar && mixer) {
                // Animation logic for different emotions
                console.log(`Animating ${emotion} expression`);
            }
        }

        // Chat Interface Functions
        function initChatInterface() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chat-messages');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Send message
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Add welcome message from Suzi
            setTimeout(() => {
                addMessage('suzi', 'Hey there! I\'m Suzi, your mental health companion. I\'m here to support you with evidence-based guidance from mental health resources and your personal medical information. Remember to be kind to yourself - you\'re doing great just by being here! üíö');
            }, 1000);
        }

        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            const message = messageInput.value.trim();
            if (!message) return;

            // Disable controls
            sendBtn.disabled = true;
            messageInput.disabled = true;
            loadingIndicator.classList.add('active');

            // Add user message
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });

            try {
                // Send to Suzi
                const response = await fetch('http://127.0.0.1:8001/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory
                    })
                });

                const data = await response.json();

                // Update conversation history
                conversationHistory = data.history || [];

                // Add Suzi's response
                addMessage('suzi', data.message);

                // Generate and play audio
                if (data.message) {
                    await generateAudio(data.message);
                }

                // Update context panel if available
                if (data.knowledge_sources && data.knowledge_sources.length > 0) {
                    updateContextPanel(data.knowledge_sources);
                }

                // Update emotion based on response content
                analyzeAndUpdateEmotion(data.message);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('suzi', 'I\'m having trouble connecting right now. Please try again in a moment.');
            } finally {
                // Re-enable controls
                sendBtn.disabled = false;
                messageInput.disabled = false;
                loadingIndicator.classList.remove('active');
                messageInput.value = '';
            }
        }

        // Voice Recognition
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const voiceBtn = document.getElementById('voiceBtn');

            if (!SpeechRecognition) {
                console.log('‚ùå Speech recognition not supported');
                voiceBtn.style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isRecording = true;
                voiceBtn.classList.add('recording');
                setEmotion('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (event.results[0].isFinal) {
                    document.getElementById('messageInput').value = transcript;
                    sendMessage();
                    stopRecording();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopRecording();
            };

            recognition.onend = () => {
                stopRecording();
            };

            voiceBtn.addEventListener('mousedown', startRecording);
            voiceBtn.addEventListener('mouseup', stopRecording);
            voiceBtn.addEventListener('mouseleave', stopRecording);
        }

        function startRecording() {
            if (!isRecording) {
                recognition.start();
            }
        }

        function stopRecording() {
            if (isRecording) {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                setEmotion('neutral');
                recognition.stop();
            }
        }

        // Medical Report Upload
        function initMedicalUpload() {
            const uploadBtn = document.getElementById('uploadReportBtn');
            const medicalInput = document.getElementById('medicalReportInput');

            uploadBtn.addEventListener('click', () => {
                medicalInput.click();
            });

            medicalInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file || !file.type.includes('pdf')) {
                    alert('Please select a PDF file');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('http://127.0.0.1:8001/upload-medical-report', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    alert(`‚úÖ ${data.message}\nTotal reports: ${data.total_user_reports}`);

                    // Clear input
                    medicalInput.value = '';

                } catch (error) {
                    console.error('Upload error:', error);
                    alert('‚ùå Upload failed. Please try again.');
                }
            });
        }

        // Audio generation
        async function generateAudio(text) {
            try {
                const response = await fetch('http://127.0.0.1:8001/process-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                audioPlayer.src = audioUrl;

                // Auto-play the audio
                audioPlayer.play().then(() => {
                    setEmotion('speaking');
                }).catch(error => {
                    console.error('Audio playback error:', error);
                    setEmotion('neutral');
                });

            } catch (error) {
                console.error('Audio generation error:', error);
            }
        }

        // Analyze text content and update avatar emotion
        function analyzeAndUpdateEmotion(text) {
            const textLower = text.toLowerCase();

            // Simple emotion detection based on keywords
            if (textLower.includes('happy') || textLower.includes('joy') || textLower.includes('excited')) {
                setEmotion('happy');
            } else if (textLower.includes('sad') || textLower.includes('worried') || textLower.includes('anxious')) {
                setEmotion('sad');
            } else if (textLower.includes('relax') || textLower.includes('calm') || textLower.includes('peaceful')) {
                setEmotion('calm');
            } else {
                setEmotion('neutral');
            }
        }

        // Context Panel Updates
        function updateContextPanel(knowledgeSources) {
            const contextPanel = document.getElementById('context-panel');
            const knowledgeSourcesDiv = document.getElementById('knowledge-sources');

            knowledgeSourcesDiv.innerHTML = '';

            knowledgeSources.forEach((source, index) => {
                const item = document.createElement('div');
                item.className = 'context-item';
                item.innerHTML = `üìñ ${source.filename || 'Reference Material'}${source.score ? ` (${(source.score * 100).toFixed(1)}% match)` : ''}`;
                knowledgeSourcesDiv.appendChild(item);
            });

            contextPanel.style.display = 'block';
        }
    </script>
</body>
</html>