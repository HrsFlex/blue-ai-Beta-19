<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suzi - Mental Health Companion</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .avatar-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 400px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #avatar-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .chat-section {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .context-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .context-panel h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #4fc3f7;
        }

        .context-item {
            background: rgba(76, 195, 247, 0.1);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            border-left: 3px solid #4fc3f7;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            flex: 1;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            background: rgba(76, 195, 247, 0.2);
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .message.suzi .message-content {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .audio-player {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #4fc3f7;
            color: #1a237e;
        }

        .progress-container {
            flex: 1;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-display {
            font-size: 0.85rem;
            margin: 0 10px;
            min-width: 100px;
            text-align: center;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .volume-slider {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .message-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 1rem;
            outline: none;
            backdrop-filter: blur(10px);
        }

        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-btn {
            background: #4fc3f7;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            color: #1a237e;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .send-btn:hover {
            background: #29b6f6;
            transform: translateY(-1px);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .voice-controls {
            text-align: center;
            padding: 15px;
        }

        .call-btn {
            background: linear-gradient(135deg, #4caf50, #45a049);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: white;
        }

        .call-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .call-btn.active {
            background: linear-gradient(135deg, #ff5252, #f44336);
            animation: pulse 1.5s infinite;
        }

        .call-btn.mute-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .call-btn.mute-btn.muted {
            background: linear-gradient(135deg, #9e9e9e, #616161);
        }

        .call-btn.speaking {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            animation: wave 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(3deg); }
            75% { transform: rotate(-3deg); }
        }

        .upload-section {
            margin-top: 10px;
            text-align: center;
        }

        .upload-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            color: #ffd54f;
        }

        .loading-indicator.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .avatar-section {
                min-height: 300px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        /* Task Suggestion Styles */
        .task-suggestion {
            margin: 15px 0;
            animation: slideIn 0.3s ease-out;
        }

        .task-suggestion-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .task-suggestion-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #fbbf24;
        }

        .task-suggestion-header i {
            font-size: 1.2rem;
        }

        .task-suggestion-body p {
            margin: 0 0 10px 0;
            font-size: 1rem;
            line-height: 1.4;
        }

        .task-suggestion-meta {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .task-suggestion-meta .task-type,
        .task-suggestion-meta .task-priority {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .task-suggestion-meta .task-type {
            background: rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        .task-suggestion-meta .task-type.appointment {
            background: rgba(236, 72, 153, 0.3);
            color: #f9a8d4;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .task-suggestion-meta .task-priority {
            background: rgba(245, 158, 11, 0.3);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.5);
        }

        .task-suggestion-meta .task-priority.high {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .task-suggestion-meta .task-priority.low {
            background: rgba(14, 165, 233, 0.3);
            color: #7dd3fc;
            border: 1px solid rgba(14, 165, 233, 0.5);
        }

        .task-suggestion-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .task-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-btn.view-dashboard {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .task-btn.view-dashboard:hover {
            background: rgba(34, 197, 94, 0.5);
            transform: translateY(-2px);
        }

        .task-btn.dismiss {
            background: rgba(107, 114, 128, 0.3);
            color: #d1d5db;
            border: 1px solid rgba(107, 114, 128, 0.5);
        }

        .task-btn.dismiss:hover {
            background: rgba(107, 114, 128, 0.5);
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ Suzi</h1>
            <p class="subtitle">Your Mental Health Companion with Medical Context</p>
        </div>

        <div class="main-content">
            <div class="avatar-section">
                <div id="avatar-container"></div>
            </div>

            <div class="chat-section">
                <div class="context-panel" id="context-panel" style="display: none;">
                    <h3>üìö Knowledge Sources</h3>
                    <div id="knowledge-sources"></div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                </div>

                <div class="controls-container">
                    <div class="audio-player">
                        <div class="player-controls">
                            <button class="control-btn" id="playPauseBtn" title="Play/Pause">‚ñ∂</button>
                            <button class="control-btn" id="stopBtn" title="Stop">‚èπ</button>
                            <div class="progress-container">
                                <div class="progress-bar" id="progressBar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                            </div>
                            <span class="time-display" id="timeDisplay">0:00</span>
                        </div>
                        <div class="volume-control">
                            <span>üîä</span>
                            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                        </div>
                        <audio id="audioPlayer" style="display: none;"></audio>
                    </div>

                    <div class="input-container">
                        <input type="text" class="message-input" id="messageInput" placeholder="Talk to Suzi about your feelings..." maxlength="1000">
                        <button class="send-btn" id="sendBtn" title="Send Message">Send</button>
                    </div>

                    <div class="voice-controls">
                        <div style="display: flex; justify-content: center; gap: 20px; align-items: center; margin-bottom: 15px;">
                            <button class="call-btn" id="micBtn" title="Click to Talk">üé§</button>
                            <button class="call-btn mute-btn" id="muteBtn" title="Mute/Unmute">üîá</button>
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 8px; opacity: 0.9; text-align: center;">
                            <span id="callStatus">Click microphone to start conversation</span>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.85rem; font-weight: 600;">Language:</label>
                                <select id="languageSelect" style="padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 0.85rem;">
                                    <option value="en">üá∫üá∏ English</option>
                                    <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                                </select>
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem;">
                                <input type="checkbox" id="autoVoiceMode" checked style="width: 14px; height: 14px;">
                                Auto Voice
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem;">
                                <input type="checkbox" id="speakerMode" style="width: 14px; height: 14px;">
                                Speaker
                            </label>
                        </div>
                    </div>

                    <div class="upload-section">
                        <button class="upload-btn" id="uploadReportBtn">üìÑ Upload Medical Report</button>
                        <input type="file" id="medicalReportInput" accept=".pdf" style="display: none;">
                    </div>

                    <div class="loading-indicator" id="loadingIndicator">
                        Suzi is thinking...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Three.js as ES module
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Three.js Avatar System
        let scene, camera, renderer, avatar, mixer;
        let clock = new THREE.Clock();
        let isLoaded = false;

        // Animation variables
        let blinkAnimation = null;
        let talkAnimation = null;
        let currentEmotion = 'neutral';

        // Audio player variables
        let audioPlayer;
        let isPlaying = false;
        let currentTime = 0;
        let duration = 0;

        // Chat variables
        let conversationHistory = [];

        // Speech Recognition
        let recognition = null;

        // Phone call mode settings
        let autoVoiceMode = true; // Enabled by default for phone call experience
        let isInCall = false;
        let isMuted = false;
        let isUserSpeaking = false;
        let isSuziSpeaking = false;
        let currentLanguage = 'en'; // Default language

        // Language configurations
        const languageConfigs = {
            'en': {
                name: 'English',
                flag: 'üá∫üá∏',
                recognitionLang: 'en-US',
                welcomeMessage: 'Hi there! I\'m Suzi, your mental health companion. Click the green microphone button to start our conversation - I\'m here to listen and support you. Think of this like a phone call with a caring friend! üìû',
                placeholder: 'Talk to Suzi about your feelings...',
                voiceId: '21m00Tcm4TlvDq8ikWAM' // ElevenLabs voice ID for English (Rachel)
            },
            'hi': {
                name: '‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)',
                flag: 'üáÆüá≥',
                recognitionLang: 'hi-IN',
                welcomeMessage: '‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§∏‡•Å‡§ú‡§º‡•Ä ‡§π‡•Ç‡§Ç, ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡§æ‡§®‡§∏‡§ø‡§ï ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§æ‡§•‡•Ä‡•§ ‡§π‡§∞‡•á ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§¨‡§æ‡§§‡§ö‡•Ä‡§§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç - ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡•Å‡§®‡§®‡•á ‡§î‡§∞ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Ç ‡§π‡•Ç‡§Ç‡•§ ‡§á‡§∏‡•á ‡§è‡§ï ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§¶‡•ã‡§∏‡•ç‡§§ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§´‡•ã‡§® ‡§ï‡•â‡§≤ ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§∏‡•ã‡§ö‡•á‡§Ç! üìû',
                placeholder: '‡§∏‡•Å‡§ú‡§º‡•Ä ‡§∏‡•á ‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§µ‡§®‡§æ‡§ì‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç...',
                voiceId: '21m00Tcm4TlvDq8ikWAM' // ElevenLabs voice ID for Hindi (Rachel multilingual)
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initAvatar();
            initAudioPlayer();
            initChatInterface();
            initVoiceRecognition();
            initMedicalUpload();
            initVoiceControls();
        });

        function initAvatar() {
            const avatarContainer = document.getElementById('avatar-container');
            const avatarSection = document.querySelector('.avatar-section');

            // Scene setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, avatarSection.offsetWidth / avatarSection.offsetHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(avatarSection.offsetWidth, avatarSection.offsetHeight);
            renderer.setClearColor(0x000000, 0);
            renderer.setPixelRatio(window.devicePixelRatio);
            avatarContainer.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(0, 2, 1);
            scene.add(pointLight);

            // Audio listener for 3D sound
            const listener = new THREE.AudioListener();
            camera.add(listener);

            // Load avatar
            loadAvatar();

            // Animation loop
            animate();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }

        function loadAvatar() {
            const loader = new GLTFLoader();

            // Try to load the model
            loader.load(
                '/static/model.glb',
                function(gltf) {
                    avatar = gltf.scene;

                    // Set avatar name for animation system
                    avatar.name = 'SuziAvatar';

                    // Position avatar
                    avatar.position.set(0, 0, 0);
                    avatar.scale.set(1, 1, 1);

                    // Setup materials for better rendering
                    setupAvatarMaterials();

                    // Add to scene
                    scene.add(avatar);

                    // Setup animations
                    setupAnimations();

                    isLoaded = true;
                    console.log('‚úÖ Avatar loaded successfully');
                },
                function(progress) {
                    // Handle loading progress
                    if (progress.lengthComputable) {
                        const percent = (progress.loaded / progress.total) * 100;
                        console.log(`Loading avatar: ${percent.toFixed(1)}%`);
                    }
                },
                function(error) {
                    console.error('‚ùå Error loading avatar:', error);
                    // Create fallback simple avatar
                    createFallbackAvatar();
                }
            );
        }

        function setupAvatarMaterials() {
            avatar.traverse((child) => {
                if (child.isMesh) {
                    // Enable shadows
                    child.castShadow = true;
                    child.receiveShadow = true;

                    // Enhance material properties
                    const material = child.material;
                    if (material) {
                        material.roughness = 0.7;
                        material.metalness = 0.2;
                        material.envMapIntensity = 0.3;

                        // Better color handling for realistic look
                        if (material.map) {
                            material.map.colorSpace = THREE.SRGBColorSpace;
                        }
                        if (material.normalMap) {
                            material.normalMap.colorSpace = THREE.NoColorSpace;
                        }
                        if (material.roughnessMap) {
                            material.roughnessMap.colorSpace = THREE.NoColorSpace;
                        }
                        if (material.metalnessMap) {
                            material.metalnessMap.colorSpace = THREE.NoColorSpace;
                        }
                        if (material.emissiveMap) {
                            material.emissiveMap.colorSpace = THREE.SRGBColorSpace;
                        }
                        if (material.occlusionMap) {
                            material.occlusionMap.colorSpace = THREE.NoColorSpace;
                        }
                    }
                }
            });
        }

        function createFallbackAvatar() {
            const geometry = new THREE.SphereGeometry(0.5, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: 0xffb6c1,
                emissive: 0x4444ff,
                shininess: 100
            });
            avatar = new THREE.Mesh(geometry, material);
            avatar.name = 'SuziAvatar'; // Set name for animation system
            avatar.position.set(0, 0, 0);
            scene.add(avatar);

            // Setup animations for fallback avatar as well
            setupAnimations();
            isLoaded = true;
            console.log('‚úÖ Fallback avatar created successfully');
        }

        function setupAnimations() {
            // Load animation data if available
            fetch('/static/blendDataBlink.json')
                .then(response => response.json())
                .then(blinkData => {
                    blinkAnimation = blinkData;
                    console.log('‚úÖ Animation data loaded');
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è No animation data found:', error);
                });

            // Create simple idle animation if no complex data
            createIdleAnimation();
        }

        function createIdleAnimation() {
            // Create mixer for the avatar
            mixer = new THREE.AnimationMixer(avatar);

            // Ensure avatar has a name for the animation track
            if (!avatar.name) {
                avatar.name = 'SuziAvatar';
            }

            // Simple breathing animation using subtle position changes
            const times = [0, 1, 2, 3, 4];
            const values = [0, 0.02, 0, -0.02, 0]; // Subtle breathing motion

            // Create proper track name for Three.js animation system
            const trackName = `${avatar.name}.position.y`;
            const track = new THREE.NumberKeyframeTrack(
                trackName, // Y position track with proper naming
                times,
                values
            );

            const clip = new THREE.AnimationClip('idle', 4, [track]);
            const action = mixer.clipAction(clip);
            action.setLoop(THREE.LoopRepeat, Infinity);
            mixer.timeScale = 1; // Normal speed

            try {
                action.play();
                console.log('‚úÖ Idle animation started successfully');
            } catch (error) {
                console.error('‚ùå Error playing idle animation:', error);
                // Continue without animation if it fails
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!isLoaded) return;

            const delta = clock.getDelta();

            // Update animations
            if (mixer) {
                mixer.update(delta);
            }

            // Subtle rotation for liveliness
            if (avatar) {
                avatar.rotation.y += delta * 0.5;
            }

            // Camera follows avatar smoothly
            if (avatar && camera) {
                camera.lookAt(avatar.position);
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const avatarSection = document.querySelector('.avatar-section');
            camera.aspect = avatarSection.offsetWidth / avatarSection.offsetHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(avatarSection.offsetWidth, avatarSection.offsetHeight);
        }

        // Enhanced Audio Player Functions
        function initAudioPlayer() {
            audioPlayer = document.getElementById('audioPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const timeDisplay = document.getElementById('timeDisplay');
            const volumeSlider = document.getElementById('volumeSlider');

            // Play/Pause button
            playPauseBtn.addEventListener('click', togglePlayPause);

            // Stop button
            stopBtn.addEventListener('click', stopAudio);

            // Progress bar
            progressBar.addEventListener('click', seekAudio);

            // Volume control
            volumeSlider.addEventListener('input', updateVolume);

            // Audio events
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('ended', onAudioEnded);
        }

        function togglePlayPause() {
            if (!audioPlayer.src || audioPlayer.src === '') {
                return;
            }

            const playPauseBtn = document.getElementById('playPauseBtn');

            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseBtn.textContent = '‚è∏';
                playPauseBtn.classList.add('active');
                isPlaying = true;
            } else {
                audioPlayer.pause();
                playPauseBtn.textContent = '‚ñ∂';
                playPauseBtn.classList.remove('active');
                isPlaying = false;
            }
        }

        function stopAudio() {
            if (audioPlayer.src) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                updateProgress();
                const playPauseBtn = document.getElementById('playPauseBtn');
                playPauseBtn.textContent = '‚ñ∂';
                playPauseBtn.classList.remove('active');
                isPlaying = false;
            }
        }

        function seekAudio(e) {
            if (audioPlayer.src && audioPlayer.duration) {
                const rect = e.currentTarget.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            }
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const timeDisplay = document.getElementById('timeDisplay');

            if (audioPlayer.duration) {
                const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = percent + '%';

                const currentMinutes = Math.floor(audioPlayer.currentTime / 60);
                const currentSeconds = Math.floor(audioPlayer.currentTime % 60);
                const durationMinutes = Math.floor(audioPlayer.duration / 60);
                const durationSeconds = Math.floor(audioPlayer.duration % 60);

                timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}/${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
            } else {
                progressFill.style.width = '0%';
                timeDisplay.textContent = '0:00';
            }
        }

        function updateDuration() {
            duration = audioPlayer.duration;
            updateProgress();
        }

        function onAudioEnded() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            playPauseBtn.textContent = '‚ñ∂';
            playPauseBtn.classList.remove('active');
            isPlaying = false;
            updateProgress();

            // Reset avatar emotion to neutral
            setEmotion('neutral');
        }

        function updateVolume() {
            const volumeSlider = document.getElementById('volumeSlider');
            audioPlayer.volume = volumeSlider.value / 100;
        }

        // Expression control
        function setEmotion(emotion) {
            currentEmotion = emotion;

            // Trigger facial expression changes
            updateAvatarEmotion(emotion);

            // Add visual feedback
            if (avatar) {
                // Change color based on emotion
                const emotionColors = {
                    'happy': '#ffeb3b',
                    'sad': '#64b5f6',
                    'neutral': '#81c784',
                    'excited': '#ff8a65',
                    'listening': '#4fc3f7',
                    'speaking': '#ff8a65'
                };

                avatar.traverse((child) => {
                    if (child.isMesh && child.material) {
                        child.material.emissive = new THREE.Color(emotionColors[emotion] || '#81c784');
                    }
                });
            }
        }

        function updateAvatarEmotion(emotion) {
            // Implementation for complex facial expressions
            if (blinkAnimation && emotion === 'happy') {
                // Trigger happy expression animation
                animateExpression(emotion);
            }
        }

        function animateExpression(emotion) {
            // Implement expression animation
            if (avatar && mixer) {
                // Animation logic for different emotions
                console.log(`Animating ${emotion} expression`);
            }
        }

        // Chat Interface Functions
        function initChatInterface() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chat-messages');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // Send message
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Add welcome message from Suzi
            setTimeout(() => {
                const config = languageConfigs[currentLanguage];
                addMessage('suzi', config.welcomeMessage);
            }, 1000);
        }

        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTaskSuggestion(task) {
            const chatMessages = document.getElementById('chat-messages');
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'task-suggestion';
            suggestionDiv.innerHTML = `
                <div class="task-suggestion-content">
                    <div class="task-suggestion-header">
                        <i class="fas fa-tasks"></i>
                        <span>Task Suggestion</span>
                    </div>
                    <div class="task-suggestion-body">
                        <p><strong>${task.title}</strong></p>
                        <div class="task-suggestion-meta">
                            <span class="task-type ${task.type}">${task.type}</span>
                            <span class="task-priority ${task.priority}">${task.priority}</span>
                        </div>
                    </div>
                    <div class="task-suggestion-actions">
                        <button class="task-btn view-dashboard" onclick="window.open('/health-dashboard', '_blank')">
                            <i class="fas fa-chart-line"></i> View Dashboard
                        </button>
                        <button class="task-btn dismiss" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> Dismiss
                        </button>
                    </div>
                </div>
            `;

            chatMessages.appendChild(suggestionDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');

            const message = messageInput.value.trim();
            if (!message) return;

            // Disable controls
            sendBtn.disabled = true;
            messageInput.disabled = true;
            loadingIndicator.classList.add('active');

            // Add user message
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });

            try {
                // Send to Suzi
                const response = await fetch('http://127.0.0.1:8001/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory,
                        language: currentLanguage
                    })
                });

                const data = await response.json();

                // Update conversation history
                conversationHistory = data.history || [];

                // Add Suzi's response
                addMessage('suzi', data.message);

                // Generate and play audio
                if (data.message) {
                    await generateAudio(data.message);
                }

                // Handle task suggestion if available
                if (data.task_suggestion) {
                    showTaskSuggestion(data.task_suggestion);
                }

                // Update context panel if available
                if (data.knowledge_sources && data.knowledge_sources.length > 0) {
                    updateContextPanel(data.knowledge_sources);
                }

                // Update emotion based on response content
                analyzeAndUpdateEmotion(data.message);

            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('suzi', 'I\'m having trouble connecting right now. Please try again in a moment.');
            } finally {
                // Re-enable controls
                sendBtn.disabled = false;
                messageInput.disabled = false;
                loadingIndicator.classList.remove('active');
                messageInput.value = '';
            }
        }

        // Voice Recognition for Phone Call Mode
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.log('‚ùå Speech recognition not supported');
                document.getElementById('micBtn').style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = languageConfigs[currentLanguage].recognitionLang;

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
            };

            recognition.onend = () => {
                // Recognition will be restarted by phone call logic if needed
            };
        }

        // Language Change Function
        function changeLanguage(languageCode) {
            if (!languageConfigs[languageCode]) {
                console.error('Language not supported:', languageCode);
                return;
            }

            const prevLang = currentLanguage;
            currentLanguage = languageCode;
            const config = languageConfigs[languageCode];

            console.log(`Changing language from ${prevLang} to ${config.name}`);

            // Update voice recognition language
            if (recognition) {
                recognition.lang = config.recognitionLang;
            }

            // Update input placeholder
            const messageInput = document.getElementById('messageInput');
            messageInput.placeholder = config.placeholder;

            // Update welcome message if no messages exist yet
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages.children.length <= 1) { // Only welcome message exists
                chatMessages.innerHTML = '';
                setTimeout(() => {
                    addMessage('suzi', config.welcomeMessage);
                }, 500);
            }

            // Add language change notification
            addMessage('suzi', `${config.flag} Language changed to ${config.name}. You can now speak in ${config.name}!`);
        }

        // Medical Report Upload
        function initMedicalUpload() {
            const uploadBtn = document.getElementById('uploadReportBtn');
            const medicalInput = document.getElementById('medicalReportInput');

            uploadBtn.addEventListener('click', () => {
                medicalInput.click();
            });

            medicalInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file || !file.type.includes('pdf')) {
                    alert('Please select a PDF file');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('http://127.0.0.1:8001/upload-medical-report', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    alert(`‚úÖ ${data.message}\nTotal reports: ${data.total_user_reports}`);

                    // Clear input
                    medicalInput.value = '';

                } catch (error) {
                    console.error('Upload error:', error);
                    alert('‚ùå Upload failed. Please try again.');
                }
            });
        }

        // Audio generation
        async function generateAudio(text) {
            try {
                const config = languageConfigs[currentLanguage];
                const response = await fetch('http://127.0.0.1:8001/process-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        language: currentLanguage,
                        voice_id: config.voiceId
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Audio generation API error:', errorData);

                    // Handle quota exceeded gracefully
                    if (errorData.error && errorData.error.includes('quota')) {
                        const callStatus = document.getElementById('callStatus');
                        if (isInCall) {
                            callStatus.textContent = 'Voice quota exceeded - Text mode only';
                        }
                        // Show visual notification
                        addMessage('suzi', 'üìµ Sorry, my voice service is temporarily unavailable. I can still chat with you via text!');
                    }
                    return;
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                audioPlayer.src = audioUrl;

                // Play the audio if not muted and auto voice is enabled
                if (autoVoiceMode && !isMuted) {
                    isSuziSpeaking = true;
                    const muteBtn = document.getElementById('muteBtn');
                    const callStatus = document.getElementById('callStatus');

                    // Update UI to show Suzi is speaking
                    muteBtn.innerHTML = '‚è∏Ô∏è';
                    if (isInCall) {
                        callStatus.textContent = 'Suzi is speaking...';
                    }

                    setEmotion('speaking');

                    audioPlayer.play().then(() => {
                        // Audio started successfully
                    }).catch(error => {
                        console.error('Audio playback error:', error);
                        isSuziSpeaking = false;
                        setEmotion('neutral');
                        if (isInCall) {
                            callStatus.textContent = 'Call in progress - Listening...';
                        }
                    });

                    // Handle audio end
                    audioPlayer.onended = () => {
                        isSuziSpeaking = false;
                        setEmotion('listening');
                        muteBtn.innerHTML = 'üîá';
                        if (isInCall) {
                            callStatus.textContent = 'Call in progress - Listening...';
                        }
                    };
                }

            } catch (error) {
                console.error('Audio generation error:', error);
                isSuziSpeaking = false;

                // Show fallback message
                const callStatus = document.getElementById('callStatus');
                if (isInCall) {
                    callStatus.textContent = 'Voice service unavailable - Text mode active';
                }
            }
        }

        // Analyze text content and update avatar emotion
        function analyzeAndUpdateEmotion(text) {
            const textLower = text.toLowerCase();

            // Simple emotion detection based on keywords
            if (textLower.includes('happy') || textLower.includes('joy') || textLower.includes('excited')) {
                setEmotion('happy');
            } else if (textLower.includes('sad') || textLower.includes('worried') || textLower.includes('anxious')) {
                setEmotion('sad');
            } else if (textLower.includes('relax') || textLower.includes('calm') || textLower.includes('peaceful')) {
                setEmotion('calm');
            } else {
                setEmotion('neutral');
            }
        }

        // Voice Controls Initialization
        function initVoiceControls() {
            const micBtn = document.getElementById('micBtn');
            const muteBtn = document.getElementById('muteBtn');
            const languageSelect = document.getElementById('languageSelect');
            const autoVoiceCheckbox = document.getElementById('autoVoiceMode');
            const speakerCheckbox = document.getElementById('speakerMode');
            const callStatus = document.getElementById('callStatus');

            // Language selection
            languageSelect.addEventListener('change', (e) => {
                const selectedLang = e.target.value;
                changeLanguage(selectedLang);
            });

            // Microphone button - toggle call state
            micBtn.addEventListener('click', () => {
                if (!isInCall) {
                    startCall();
                } else {
                    endCall();
                }
            });

            // Mute button - stop audio and listen
            muteBtn.addEventListener('click', () => {
                if (isSuziSpeaking) {
                    muteSuzi();
                } else {
                    unmuteSuzi();
                }
            });

            // Auto voice mode toggle
            autoVoiceCheckbox.addEventListener('change', (e) => {
                autoVoiceMode = e.target.checked;
                console.log('Auto Voice Mode:', autoVoiceMode ? 'ON' : 'OFF');
            });

            // Speaker mode toggle
            speakerCheckbox.addEventListener('change', (e) => {
                console.log('Speaker Mode:', e.target.checked ? 'ON' : 'OFF');
            });
        }

        // Phone Call Functions
        function startCall() {
            const micBtn = document.getElementById('micBtn');
            const callStatus = document.getElementById('callStatus');

            console.log('üìû Starting call...');
            isInCall = true;
            micBtn.classList.add('active');
            micBtn.innerHTML = 'üî¥';
            callStatus.textContent = 'Call in progress - Listening...';

            // Start voice recognition for the call
            if (recognition) {
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = handleCallVoiceResult;
                recognition.onstart = () => {
                    setEmotion('listening');
                    isUserSpeaking = true;
                };
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    // Restart recognition after a short delay if still in call
                    if (isInCall) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('Recognition restart failed:', e);
                            }
                        }, 1000);
                    }
                };
                recognition.onend = () => {
                    // Restart recognition if still in call
                    if (isInCall && !isSuziSpeaking) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('Recognition restart failed:', e);
                            }
                        }, 500);
                    }
                };

                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting voice recognition:', error);
                }
            }

            // Set avatar to listening state
            setEmotion('listening');
        }

        function endCall() {
            const micBtn = document.getElementById('micBtn');
            const callStatus = document.getElementById('callStatus');

            console.log('üìû Ending call...');
            isInCall = false;
            micBtn.classList.remove('active');
            micBtn.innerHTML = 'üé§';
            callStatus.textContent = 'Click microphone to start conversation';

            // Stop voice recognition
            if (recognition) {
                recognition.stop();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.onresult = handleNormalVoiceResult;
            }

            // Stop any playing audio
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
            }

            // Reset states
            isUserSpeaking = false;
            isSuziSpeaking = false;
            isMuted = false;

            // Update mute button
            const muteBtn = document.getElementById('muteBtn');
            muteBtn.classList.remove('muted');
            muteBtn.innerHTML = 'üîá';

            // Set avatar to neutral
            setEmotion('neutral');
        }

        function muteSuzi() {
            const muteBtn = document.getElementById('muteBtn');
            const callStatus = document.getElementById('callStatus');

            console.log('üîá Muting Suzi...');
            isMuted = true;

            // Stop any playing audio
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
            }

            // Update UI
            muteBtn.classList.add('muted');
            muteBtn.innerHTML = 'üîä';
            callStatus.textContent = 'Suzi muted - You can speak now';

            // Set avatar to listening state
            setEmotion('listening');
            isSuziSpeaking = false;
        }

        function unmuteSuzi() {
            const muteBtn = document.getElementById('muteBtn');
            const callStatus = document.getElementById('callStatus');

            console.log('üîä Unmuting Suzi...');
            isMuted = false;

            // Update UI
            muteBtn.classList.remove('muted');
            muteBtn.innerHTML = 'üîá';
            callStatus.textContent = 'Call in progress - Listening...';
        }

        function handleCallVoiceResult(event) {
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }

            // Update input field for visual feedback
            const messageInput = document.getElementById('messageInput');
            if (interimTranscript) {
                messageInput.value = finalTranscript + interimTranscript;
            }

            // Process final results
            if (finalTranscript.trim()) {
                messageInput.value = finalTranscript.trim();

                // Send message and continue listening
                setTimeout(() => {
                    sendMessage();

                    // Continue listening if still in call and Suzi is not speaking
                    if (isInCall && !isSuziSpeaking) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (error) {
                                console.log('Recognition already running');
                            }
                        }, 1000);
                    }
                }, 500);
            }
        }

        function handleNormalVoiceResult(event) {
            const transcript = event.results[0][0].transcript;
            if (event.results[0].isFinal) {
                document.getElementById('messageInput').value = transcript;
                sendMessage();
                stopRecording();
            }
        }

        // Context Panel Updates
        function updateContextPanel(knowledgeSources) {
            const contextPanel = document.getElementById('context-panel');
            const knowledgeSourcesDiv = document.getElementById('knowledge-sources');

            knowledgeSourcesDiv.innerHTML = '';

            knowledgeSources.forEach((source, index) => {
                const item = document.createElement('div');
                item.className = 'context-item';
                item.innerHTML = `üìñ ${source.filename || 'Reference Material'}${source.score ? ` (${(source.score * 100).toFixed(1)}% match)` : ''}`;
                knowledgeSourcesDiv.appendChild(item);
            });

            contextPanel.style.display = 'block';
        }
    </script>
</body>
</html>